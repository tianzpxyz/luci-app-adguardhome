name: build-ipk

on:
  push:
    tags: ['*']

permissions:
  contents: write

env:
  TARGET: x86
  SUBTARGET: 64
  PKG_DIR_NAME: luci-app-adguardhome

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget zstd jq

      - name: ä¸‹è½½å¹¶è§£å‹ SDK
        run: |
          set -euo pipefail

          echo "ğŸ” è·å– OpenWrt æœ€æ–°ç¨³å®šç‰ˆ..."
          LATEST_TAG=$(
            curl -fsSL https://api.github.com/repos/openwrt/openwrt/releases?per_page=50 \
            | jq -r '.[] | select(.prerelease==false) | .tag_name' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1
          )

          if [[ -z "${LATEST_TAG}" || "${LATEST_TAG}" == "null" ]]; then
            echo "âŒ è·å– OpenWrt tag å¤±è´¥"
            exit 1
          fi

          RELEASE="${LATEST_TAG#v}"
          echo "æ£€æµ‹åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬: ${RELEASE}"

          echo "ğŸ“¥ ä¸‹è½½ SDK..."
          BASE="https://downloads.openwrt.org/releases/${RELEASE}/targets/${TARGET}/${SUBTARGET}/"
          SDK_TARBALL=$(curl -fsSL "$BASE" | grep -o 'openwrt-sdk-[^"]*\.tar\.zst' | head -n1)
          mkdir -p _sdk
          wget -q "${BASE}${SDK_TARBALL}" -O _sdk/sdk.tar.zst
          tar --zstd -xf _sdk/sdk.tar.zst -C _sdk
          SDK_DIR="$(find "$PWD/_sdk" -maxdepth 1 -type d -name 'openwrt-sdk-*' -print -quit)"
          echo "SDK_DIR=${SDK_DIR}" >> "$GITHUB_ENV"
          echo "âœ… SDK å·²è§£å‹åˆ°: ${SDK_DIR}"

      - name: å°†åŒ…æ‹·å…¥ SDK
        run: |
          cd "$SDK_DIR"
          mkdir -p package/${PKG_DIR_NAME}
          rsync -a --delete "$GITHUB_WORKSPACE/" "package/${PKG_DIR_NAME}/" \
            --exclude '.git' --exclude '.github' --exclude '_sdk' --exclude 'out'

      - name: ä»…æ›´æ–° luci æºå¹¶å®‰è£… luci-base
        run: |
          cd "$SDK_DIR"
          ./scripts/feeds update luci
          ./scripts/feeds install luci-base

      - name: ç”Ÿæˆé»˜è®¤é…ç½®
        run: |
          cd "$SDK_DIR"
          make defconfig

      - name: ç¼–è¯‘åŒ…
        run: |
          cd "$SDK_DIR"
          make package/${PKG_DIR_NAME}/clean V=s || true
          make package/${PKG_DIR_NAME}/compile -j"$(nproc)" V=sc

      - name: å‘å¸ƒ Releases
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          files: ${{ env.SDK_DIR }}/bin/packages/*/*${{ env.PKG_DIR_NAME }}*.ipk